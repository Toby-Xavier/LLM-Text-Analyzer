import os
from dotenv import load_dotenv
import sys
from analyzer import analyze_batch, export_to_excel

def print_banner():
    """Print a nice banner"""
    print("\n" + "="*60)
    print("  LLM TEXT ANALYZER")
    print("  Powered by Google Gemini")
    print("="*60 + "\n")

def get_user_inputs():
    """Get analysis inputs from the user"""
    print("How would you like to provide your text for analysis?\n")
    print("1. Type/paste text directly")
    print("2. Provide URLs to analyze")
    print("3. Load from a text file (one item per line)")
    
    choice = input("\nEnter a choice (1-3): ").strip()
    
    inputs = []
    
    if choice == "1":
        print("\n Enter your texts (type 'DONE' on a new line when finished):\n")
        while True:
            text = input("> ")
            if text.strip().upper() == "DONE":
                break
            if text.strip():
                inputs.append(text.strip())
    
    elif choice == "2":
        print("\n Enter URLs (type 'DONE' on a new line when finished):\n")
        while True:
            url = input("> ")
            if url.strip().upper() == "DONE":
                break
            if url.strip():
                inputs.append(url.strip())
    
    elif choice == "3":
        filepath = input("\n Enter the path to your text file: ").strip()
        try:
            with open(filepath, 'r') as f:
                inputs = [line.strip() for line in f if line.strip()]
            print(f"‚úÖ Loaded {len(inputs)} items from file")
        except FileNotFoundError:
            print(f"‚ùå File not found: {filepath}")
            return None
        except Exception as e:
            print(f"‚ùå Error reading file: {e}")
            return None
    
    else:
        print("‚ùå Invalid choice")
        return None
    
    return inputs

def main():
    """Main function to run the analyzer"""
    load_dotenv()
    
    # Check for API key
    if not os.getenv('GEMINI_API_KEY'):
        print("Error: GEMINI_API_KEY not found in .env file")
        print("Please create a .env file with your API key")
        sys.exit(1)
    
    print_banner()
    
    # Get inputs from user
    inputs = get_user_inputs()
    
    if not inputs:
        print("‚ùå No valid inputs provided. Exiting.")
        return
    
    print(f"\n Ready to analyze {len(inputs)} item(s)")
    
    # Ask for analysis type
    print("\n Analysis type:")
    print("1. Sentiment analysis (default)")
    print("2. Summary")
    print("3. Key themes")
    
    analysis_choice = input("\nEnter choice (1-3, or press Enter for default): ").strip()
    
    analysis_types = {
        "1": "sentiment",
        "2": "summary", 
        "3": "themes",
        "": "sentiment"
    }
    
    analysis_type = analysis_types.get(analysis_choice, "sentiment")
    
    # Run analysis
    print(f"\nüöÄ Starting {analysis_type} analysis...\n")
    results = analyze_batch(inputs, analysis_type)
    
    if not results:
        print("\n‚ùå No results generated. Please check your inputs and try again.")
        return
    
    print("\n" + "="*60)
    print(f"‚úÖ Analysis complete! Processed {len(results)} item(s)")
    print("="*60)
    
# Ask user which export format they want
    print("\n Export format:")
    print("1. Excel file (local)")
    print("2. Google Sheets (cloud)")
    
    export_choice = input("\nEnter choice (1-2): ").strip()
    
    if export_choice == "2":
        # Google Sheets export
        sheet_name = input("\n Enter sheet name (or press Enter to auto-generate a name): ").strip()
        
        if not sheet_name:
            sheet_name = None
        
        from analyzer import export_to_google_sheets
        sheet_url = export_to_google_sheets(results, sheet_name)
        
        if sheet_url:
            print(f"\nSUCCESS!")
            print(f"Google Sheet URL: {sheet_url}")
            print(f"\nYou can access this sheet from any device!")
    else:
        # Excel export (existing code)
        output_filename = input("\n Enter output filename (or press Enter for auto-generated): ").strip()
        
        if not output_filename:
            output_filename = None
        
        from analyzer import export_to_excel
        excel_file = export_to_excel(results, output_filename)
        
        if excel_file:
            print(f"\nüéâ SUCCESS!")
            print(f" Results saved to: {excel_file}")
            print(f"\nYou can now open this file in Excel or Google Sheets!")
    
    print("\n" + "="*60)
    print("Thanks for using LLM Text Analyzer!")
    print("="*60 + "\n")

if __name__ == "__main__":
    main()